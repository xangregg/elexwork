Names Default to Here(1);// script for cleaning up this particular elections results CSV file produces by TabulaPDF// Cleans up CSV issues such as extra commas and missing commas, plus some had-picked exceptions.// Produces a separate CSV file for each contest.// Records any discarded dup in a separate "dup" csv file.// Records any other discarded text in a separate "extra" text file.workdir = "work";If( !Directory Exists( workdir ), Create Directory( workdir ));in file name = "tabulaHudsonCountyNJ.csv";base file name = "20161108__nj__general__hudson__county";dup file name = workdir || "/" || base file name || "_dup.csv";extra file name = workdir || "/" || base file name || "_extra.txt";// initial list is source rows starting with "",,contests = {	"Board of Education - Bayonne",	"Board of Education - Bayonne 2 Yr Unexpired Term",	"Board of Education - Guttenberg",	"Board of Education - Hoboken",	"Board of Education - Jersey City",	"Board of Education - Kearny",	"Board of Education - Secaucus",	"Board of Education - West New York",	"Constitutional Amendment #1- Gambling",	"Constitutional Amendment #2-Transportation",	"County Register",	"County Sheriff",	"East Newark Council At Large",	"Guttenberg Council - Unexpired Term",	"Harrison Ward 2 Council - Unexpired Term",	"House of Representatives 10th District",	"House of Representatives 8th District",	"House of Representatives 9th District",	"Jersey City Public Question #1",	"Jersey City Public Question #2",	"Jersey City Ward B Council - Unexpired Term",	"President and Vice President",	"Secaucus Public Question"};// Tabula doesn't process the rotated column headers well, so we hard code them (pulled from the "extra" output)headers = {"President and Vice President","Clinton/Kaine,Trump/Pence,La Riva/Puryear,Stein/Baraka,Johnson/Weld,Kennedy/Hart,Castle/Bradley,De La Fuente/Steinberg,Moorehead/Lily,Personal Choice","House of Representatives 8th District","Albio Sires,Agha Khan,Pablo Olivera,Dan Delaney,Personal Choice ","House of Representatives 9th District","Bill Pascrell Jr.,Hector L. Castillo,Jeff Boss,Diego Rivera,Personal Choice","House of Representatives 10th District","Donald M. Payne Jr.,David H. Pinckney,Joanne Miller,Aaron Walter Fraser,Personal Choice","County Sheriff","Frank X. Schillari,Mark Borchert,Personal Choice","County Register","Diane Coleman,Omar Salgado,Personal Choice ","East Newark Council At Large","Charles F. Tighe,Jose A. Silva,Personal Choice","Guttenberg Council - Unexpired Term","Wayne D. Zitt Jr.,Personal Choice","Harrison Ward 2 Council - Unexpired Term","Eleanor Villalta,Personal Choice","Jersey City Ward B Council - Unexpired Term","Chris L. Gadsden,John J. Hallanan III,Lekendrick Shaw,Personal Choice","Board of Education - Bayonne","George J. Vinc Jr.,Carol R. Cruden,Sharma L. Montgomery,Leonard R. Kantor,Mary Jane Desmond,Denis F. Wilbeck,Gina Irizarry,John Milan Sebik,Michael J. Alonso,Personal Choice","Board of Education - Bayonne 2 Yr Unexpired Term","John R. Cupo,Maria Valado,Charles Ryan,Personal Choice","Board of Education - Guttenberg","William Hokien,Marisol Montanez,Elsa A. Schwarz,Lourdes P. Gomez,Jason Aydelott,Mark R. Rogers,Personal Choice","Board of Education - Hoboken","Jennifer A. Evans,Sheillah Dallara,Jessica Nelson,Irene Sbolov,Jennifer Rossini,Francis Chipper Benway,Personal Choice","Board of Education - Jersey City","Sudhan Thoms,Natalia Ioffe,Angel L. Valentin,Mark Rowan,Luis Felipe Fernandez,Mussab Ali,Kimberly Goycochea,Asmaa Abdalla,Gina Verdibello,Matthew Schapiro","Board of Education - Jersey City","Personal Choice","Board of Education - Kearny","Bernadette McDonald,Theresa Andryszczak,Barbara Cifelli-Sherry,George A. Zapata,Samantha Paris,Personal Choice","Board of Education - Secaucus","Kathy O'Connell,Steven Kilawattie,Sharon Dellafave,Tom A. Troyer,Jack A. McStowe,John Gerbasio,Personal Choice","Board of Education - West New York","Ronald C. Scheurle,Alex Navas,John Smith,Melinda Saunders,Juan Carlos Alvarado,David Morel,Jose M. Alcantara,Adam Parkinson,Personal Choice","Constitutional Amendment #1- Gambling","Yes,No","Constitutional Amendment #2-Transportation","Yes,No","Jersey City Public Question #1","Yes,No","Jersey City Public Question #2","Yes,No","Secaucus Public Question","Yes,No","Extra","None"};ih = 1;contest = "President and Vice President";in file = Load Text File( in file name );out file = "";//"source line,contest,precinct,total,registered,ballots,turnout\!r\!n";extra = "";dup file = "dup line,source line,contest,precinct,total,registered,ballots,turnout\!r\!n";in lines = Words( infile, "\!r\!n" );n lines = N Items( in lines );all seen = Associative Array();wasdup = 0;countOccurrences = Function( {a, b},	{i = 1, n = 0},	While( i >= 1 & i <= Length( a ),		i = Contains( a, b, i );		If( i > 0,			n++;			i += Length( b );		);	);	n;);//countOccurrences("abacabba", "ab");il = 3706;	// for debuggingprev = "";For( il = 1, il <= n lines, il++,	If( Mod( ih, 2 ) == 1, 		// start of a new file		//contest = headers[ih];		ih++;		out file = "source line,contest,precinct,total,registered,ballots,turnout," || headers[ih] || "\!r\!n";		headings = Words( outfile, "," );		nheadings = N Items( headings );	);	s = in lines[il];	prefix = "";	If( Starts With( s, "\!"\!"," ),		s = Regex( s, "\!"", "", globalreplace );		//two = Starts With(s, ",,");		s = Regex( s, ",", "", globalreplace );		extra ||= Char( il ) || "," || s || "\!r\!n";		If( Contains( contests, s ),			contest = s		);	, 		// clean-up number separators		//Secaucus Ward 2,,Total,3892,2480,63.72,1178,716		//Secaucus,,Total,11232,7703,68.58,3453,2207		//Contest Total,,,11232,7703,68.58,3453,2207		s = Regex( s, "(\d),,+([^,\d])", "\1,\2", globalreplace );		s = Regex( s, "([^,\d]),,+(\d)", "\1,\2", globalreplace );		s = Regex( s, "([^,\d]),,+([^,\d])", "\1,\2", globalreplace );		//s = regex(s, ",,+", ",", globalreplace);		s = Regex( s, "(\d) (\d)", "\1,\2", globalreplace );		s = Regex( s, "(\d) (\d)", "\1,\2", globalreplace );	// again for overlaps		s = Regex( s, ",+$", "", globalreplace );	// trailing commas				// many precincts end with " D#", but sometimes the following comma is missing		t = Regex( s, " (D\d+) ?([^,\d])", " \1,\2", globalreplace );		t = Regex( t, " (Ward \d+) ?([^,\d])", " \1,\2", globalreplace );		t = Regex( t, "(Unassigned SubDistrict|Prov|Mail-In)( ?)([^,])", "\1,\3", globalreplace );				added comma after precint = s != t;		s = t;		//s = regex(s, "\(10th,", "(10th Cong)||snext,", globalreplace);		s = Regex( s, "Total (\d)", "Total,\1", globalreplace );		s = Regex( s, " (\d+,\d+,\d+\.\d\d)", ",\1", globalreplace );		If( !added comma after precint,			s = Regex( s, "^([^,]+) Total", "\1,Total", globalreplace )		);		//if (!added comma after precint, s = regex(s, " Total", ",Total", globalreplace));		se = Regex( s, ",([^,]*)T([^,]*)o([^,]*)t([^,]*)a([^,]*)l([^,]*),", "\1\2\3\4\5\6" );				If( Is Missing( se ) & se != "", 			// no "Total" in line			If( !Is Missing( Regex( s, "\d\d" ) ),				Print( "no total", il, s )	// suspicious: a number without "total"			);			If( Contains( s, "Prov" ) | Contains( s, "Mail" ), 			// looks like it's a continuuation of a long precinct name, so inject into previous line				If( !wasdup,					s = Regex( s, ",", "", globalreplace );					prev2 = Regex( prev, "^([^,]+),([^,]+)" );					prev2 = prev2 || s || Substr( prev, Length( prev2 ) + 1 );					out file = Substr( outfile, 1, Length( out file ) - Length( prev ) - 2 );					out file ||= prev2 || "\!r\!n";				)			, 				// else record it				extra ||= Char( il ) || "," || s || "\!r\!n"			);		,			If( se != "",				extra ||= Char( il ) || "," || se || "\!r\!n"			);			// remove header mixed in with Total			s = Regex( s, ",[^,]*T[^,]*o[^,]*t[^,]*a[^,]*l[^,]*,", ",Total,", globalreplace );						// special case			s = Regex( s, ",Turnout \(%\),", ",", globalreplace );						// make sure there's only one comma before Total -- sometimes a header gets spliced in			se2 = Regex( s, "([^,]+),([^,]+),(Total,\d+,\d+,\d+\.\d\d)", "\2" );			If( !Is Missing( se2 ),				If( Contains( se2, "Prov" ) | Contains( se2, "Mail" ),					s = Regex( s, "([^,]+),([^,]+),(Total,\d+,\d+,\d+\.\d\d)", "\1 \2,\3", globalreplace ),					s = Regex( s, "([^,]+),([^,]+),(Total,\d+,\d+,\d+\.\d\d)", "\1,\3", globalreplace );					If( se2 != "",						extra ||= Char( il ) || "," || se2 || "\!r\!n"					);				)			);						// sometimes the last vote count comes out as a prefix to the Total field			//Jersey City WA D23,1Ballots CastTotal,574 337 58.71,204,29,			//Jersey City WA D28,198Ballots Cast,Total,690 411 59.57 90			senum = Regex( se, "^(\d+)" );			If( Is Missing( senum ),				senum = Regex( se2, "^(\d+)" )			);			If( !Is Missing( senum ),				If( !Ends With( s, "," ),					s ||= ","				);				Print( "appending", s, s || senum );				s ||= senum;			);			// exception for a precinct field of "prov"			If( il == 1468,				If( !Starts With( s, "Prov," ),					Print( "expected Prov exception not found." )				);				s = Regex( s, "^Prov,", "Jersey City Ward B (8th Cong) Prov,", globalreplace );			);						s = contest || "," || s;						// a couple places have extra commas in the data area			// Secaucus,,Total,11232 7703 68.58 3453,,2207			If( countOccurrences( s, ",," ) == 1 & countOccurrences( s, "," ) == nheadings - 1,				Print( "extra data comma  " || Char( il ) || "   " || s );				Substitute Into( s, ",,", "," );			);						// error			//if (il == 5029 & s == "Board of Education - Kearny,Kearny W2 D2,Total,516,336,65.12,83,53,86,47,44"),			//	s ||= ",1";			//);			// clean this missed dups			If( s == "Board of Education - Jersey City,RegisteredJersey City WA D21,Total,786,478,60.81,1",				s = "Board of Education - Jersey City,Jersey City WA D21,Total,786,478,60.81,1"			);			// misplaced commas			s = Match( s,				"House of Representatives 8th District,East Newark Mail-In,Total,0,26,0.00,15,1,1",				"House of Representatives 8th District,East Newark Mail-In,Total,0,26,0.00,15,,1,1",				"House of Representatives 8th District,Jersey City WF D5,Total,457,254,55.58,205,1,1",				"House of Representatives 8th District,Jersey City WF D5,Total,457,254,55.58,205,,1,1",				"House of Representatives 8th District,Jersey City WB D15,Total,15,8,53.33,3,1",				"House of Representatives 8th District,Jersey City WB D15,Total,15,8,53.33,3,,1",				"House of Representatives 10th District,Jersey City WF D21,Total,878,476,54.21,325,8,5,,2",				"House of Representatives 10th District,Jersey City WF D21,Total,878,476,54.21,325,8,5,2",				"House of Representatives 10th District,Jersey City WF D22,Total,575,315,54.78,201,11,6,,2",				"House of Representatives 10th District,Jersey City WF D22,Total,575,315,54.78,201,11,6,2",				"House of Representatives 10th District,Jersey City WF D23,Total,696,438,62.93,348,1,9,,2",				"House of Representatives 10th District,Jersey City WF D23,Total,696,438,62.93,348,1,9,2",				"House of Representatives 10th District,Jersey City WF D24,Total,980,521,53.16,376,2,3,,3",				"House of Representatives 10th District,Jersey City WF D24,Total,980,521,53.16,376,2,3,3",				"House of Representatives 10th District,Jersey City WF D25,Total,811,331,40.81,214,11,3,,1",				"House of Representatives 10th District,Jersey City WF D25,Total,811,331,40.81,214,11,3,1",				"House of Representatives 10th District,Jersey City WF D29,Total,1055,652,61.80,399,21,9,,6",				"House of Representatives 10th District,Jersey City WF D29,Total,1055,652,61.80,399,21,9,6",				"House of Representatives 10th District,Jersey City Ward B (10th,Total,0,379,0.00,284,42,6,,5",				"House of Representatives 10th District,Jersey City Ward B (10th,Total,0,379,0.00,284,42,6,5",				"House of Representatives 10th District,Jersey City Ward B (10th,Total,0,767,0.00,254,28,11,,4",				"House of Representatives 10th District,Jersey City Ward B (10th,Total,0,767,0.00,254,28,11,4",				"House of Representatives 10th District,Overseas Ballot 10th Cong,Total,0,76,0.00,62,6,6,,2",				"House of Representatives 10th District,Overseas Ballot 10th Cong,Total,0,76,0.00,62,6,6,2",				"House of Representatives 10th District,Unassigned SubDistrict,Total,0,1146,0.00,538,70,17,,9",				"House of Representatives 10th District,Unassigned SubDistrict,Total,0,1146,0.00,538,70,17,9",				"Constitutional Amendment #1- Gambling,Jersey City WB D15,Total,15,8,53.33,3",				"Constitutional Amendment #1- Gambling,Jersey City WB D15,Total,15,8,53.33,,3",				s			);			If( all seen << Contains Item( s ), 				//print("duplicate: " || char(il) || "," || char(all seen[s]) || "," || s);				dup file ||= Char( il ) || "," || Char( all seen[s] ) || "," || s || "\!r\!n";				was dup = 1;			,				all seen[s] = il;				prev = s;				out file ||= Char( il ) || "," || s || "\!r\!n";				If( Contains( s, ",Contest," ),					Print( il, ih, contest, headers[ih - 1] );					Save Text File( workdir || "/" || "contest" || Substr( Char( 100 + ih / 2 ), 2 ) || "." || base file name || ".csv", out file );					outfile = "";					prev = "";					ih++;				);				was dup = 0;			);		);	););Save Text File( dup file name, dup file );Save Text File( extra file name, extra );Print( "done" );